# 原理与手工部署

![](./doc/img.png)

## 分片集群组成部分

### Shard 分片服务器

存储实际的数据块

### Config Server 配置服务器

存储了整个 分片群集的配置信息 (从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS）)

### Query Routers 路由服务器

接受Client 端请求

## 手工部署

- Router Server * 1  
- Config Server * 3  (至少拥有两个副本 不然服务启动)
- Shard Server * 3   


> 提示：部署多个mongos路由器支持高可用性和可伸缩性。常见的模式是mongos在每个应用程序服务器上放置一个，可以减少应用程序和路由器之间的网络延迟。
也可以将mongos路由器放在专用主机上，通过用于大型规模部署。因为它将客户端应用程序服务器的数量与mongos实例数量分离。这样可以更好地控制mongod实例所服务的连接数。
注意：mongos路由器部署的数量没有限制。但是，由于mongos路由器经常与Config Server通信，因此在增加路由器数量时会密切监视配置服务器性能。如果发现性能下降，那么可以适当限制mongos路由器部署的数量。

我们使用docker进行部署 `mongo:latest`   

网络我们使用 `network_mode: bridge`

### Config Server 
创建 加密key

`openssl rand -base64 100 > /etc/mongo/mongo.key`

`chmod 600 /etc/mongo/mongo.key`

mongodb_config_server.conf
``` 
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/config.log

storage:
  dbPath: /var/lib/mongodb/config
  journal:
    enabled: true
  wiredTiger:
    engineConfig:
      directoryForIndexes: true

processManagement:
  # fork: true #后台运行
  # pidFilePath: /var/run/mongodb/config.pid
  timeZoneInfo: /usr/share/zoneinfo

net:
  port: 37017
  bindIp: 0.0.0.0
  maxIncomingConnections: 5000 设定最大同时连接数，默认为2000

security:
  keyFile: /etc/mongo/mongo.key
  authorization: enabled

replication:
  replSetName: configs

sharding:    #配置服务
  clusterRole: configsvr 
```

docker-compose: 

``` 
version: '3.1'

services:
  mongo_config_server:
    network_mode: bridge
    image: mongo:latest
    restart: always
    ports:
      - 37017:37017
    volumes:
      - ./mongo_config_server_data:/data/mongodb
      - ./mongo_config_server_log:/data/logs
      - /usr/share/zoneinfo:/usr/share/zoneinfo
      - ./config/mongodb_config_server.conf:/etc/mongo/mongodb_config_server.conf
      - ./config/security.key:/etc/mongo/mongo.key
      - ./run.sh:/data/run.sh
    command:
      bash /data/run.sh

```

*配置参数*

``` 
mongo --port 37017

config = { _id: "configs", members: [
    {_id: 0, host: "192.168.88.39:37017"},
    {_id: 1, host: "192.168.88.40:37017"},
    {_id: 2, host: "192.168.88.41:37017"}]
}
```

*初始化副本集*

``` 
rs.initiate(config)  #初始化集群

rs.status()		#查看集群状态
```

### Shard Server 1
/etc/mongo/shard1.conf
``` 

```

### 参考
- https://docs.mongodb.com/v5.0/sharding/
- https://docs.mongodb.com/v5.0/tutorial/deploy-shard-cluster/
- https://www.cnblogs.com/itzgr/p/11022248.html#_label1_3

